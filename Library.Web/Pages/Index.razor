// =============================================================
// Fichier : Library.Web/Services/BookApiService.cs
// Rôle    : Service HTTP appelant l'API interne depuis Blazor.
//           Fait le lien entre les pages Blazor et l'API REST.
//           POO : injection de HttpClient, encapsulation des appels.
// =============================================================

using System.Net.Http.Json;
using Library.Shared.Models;

namespace Library.Web.Services
{
    /// <summary>
    /// Service qui communique avec l'API interne Library.API.
    /// Toutes les opérations CRUD passent par ce service.
    /// Utilise HttpClient (injecté) pour les appels HTTP.
    /// </summary>
    public class BookApiService
    {
        // -------------------------------------------------------
        // Dépendance injectée
        // -------------------------------------------------------
        private readonly HttpClient _http;

        // URL de base de l'API (configurée dans appsettings.json)
        private const string ApiBase = "api/books";

        public BookApiService(HttpClient http)
        {
            _http = http;
        }

        // -------------------------------------------------------
        // READ — Récupérer tous les livres
        // -------------------------------------------------------
        /// <summary>Récupère tous les livres depuis l'API.</summary>
        public async Task<List<Book>> GetAllBooksAsync()
        {
            try
            {
                var books = await _http.GetFromJsonAsync<List<Book>>(ApiBase);
                return books ?? new List<Book>();
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"Erreur GetAllBooks: {ex.Message}");
                return new List<Book>();
            }
        }

        // -------------------------------------------------------
        // READ — Récupérer un livre par ID
        // -------------------------------------------------------
        /// <summary>Récupère un livre par son ID.</summary>
        public async Task<Book?> GetBookByIdAsync(int id)
        {
            try
            {
                return await _http.GetFromJsonAsync<Book>($"{ApiBase}/{id}");
            }
            catch
            {
                return null;
            }
        }

        // -------------------------------------------------------
        // READ — Rechercher des livres
        // -------------------------------------------------------
        /// <summary>Recherche des livres par titre, auteur ou genre.</summary>
        public async Task<List<Book>> SearchBooksAsync(string query)
        {
            try
            {
                var encoded = Uri.EscapeDataString(query);
                var books = await _http.GetFromJsonAsync<List<Book>>($"{ApiBase}/search?q={encoded}");
                return books ?? new List<Book>();
            }
            catch
            {
                return new List<Book>();
            }
        }

        // -------------------------------------------------------
        // CREATE — Créer un livre
        // -------------------------------------------------------
        /// <summary>Crée un nouveau livre via l'API.</summary>
        public async Task<Book?> CreateBookAsync(Book book)
        {
            try
            {
                var response = await _http.PostAsJsonAsync(ApiBase, book);
                if (response.IsSuccessStatusCode)
                    return await response.Content.ReadFromJsonAsync<Book>();
                return null;
            }
            catch
            {
                return null;
            }
        }

        // -------------------------------------------------------
        // UPDATE — Mettre à jour un livre
        // -------------------------------------------------------
        /// <summary>Met à jour un livre existant.</summary>
        public async Task<Book?> UpdateBookAsync(int id, Book book)
        {
            try
            {
                var response = await _http.PutAsJsonAsync($"{ApiBase}/{id}", book);
                if (response.IsSuccessStatusCode)
                    return await response.Content.ReadFromJsonAsync<Book>();
                return null;
            }
            catch
            {
                return null;
            }
        }

        // -------------------------------------------------------
        // DELETE — Supprimer un livre
        // -------------------------------------------------------
        /// <summary>Supprime un livre par son ID.</summary>
        public async Task<bool> DeleteBookAsync(int id)
        {
            try
            {
                var response = await _http.DeleteAsync($"{ApiBase}/{id}");
                return response.IsSuccessStatusCode;
            }
            catch
            {
                return false;
            }
        }

        // -------------------------------------------------------
        // TOGGLE — Changer la disponibilité
        // -------------------------------------------------------
        /// <summary>Inverse la disponibilité d'un livre.</summary>
        public async Task<Book?> ToggleAvailabilityAsync(int id)
        {
            try
            {
                var response = await _http.PatchAsync($"{ApiBase}/{id}/toggle", null);
                if (response.IsSuccessStatusCode)
                    return await response.Content.ReadFromJsonAsync<Book>();
                return null;
            }
            catch
            {
                return null;
            }
        }

        // -------------------------------------------------------
        // EXTERNAL — Recherche OpenLibrary
        // -------------------------------------------------------
        /// <summary>Recherche des livres dans l'API externe OpenLibrary.</summary>
        public async Task<List<Book>> SearchOpenLibraryAsync(string query)
        {
            try
            {
                var encoded = Uri.EscapeDataString(query);
                var books = await _http.GetFromJsonAsync<List<Book>>($"api/openlibrary/search?q={encoded}&limit=10");
                return books ?? new List<Book>();
            }
            catch
            {
                return new List<Book>();
            }
        }

        /// <summary>Importe un livre depuis OpenLibrary dans la base locale.</summary>
        public async Task<Book?> ImportFromOpenLibraryAsync(Book book)
        {
            try
            {
                var response = await _http.PostAsJsonAsync("api/openlibrary/import", book);
                if (response.IsSuccessStatusCode)
                    return await response.Content.ReadFromJsonAsync<Book>();
                return null;
            }
            catch
            {
                return null;
            }
        }
    }
}